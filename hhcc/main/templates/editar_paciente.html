{% extends "base.html" %}
{% load static %}

{% block title %}Editar Paciente - Dr. Omar Prieto{% endblock %}

{% block extra_css %}
<!-- Estilos adicionales específicos para esta página -->
<style>
  .form-container {
    width: 95%;
    max-width: 800px;
    margin: 0 auto;
  }
  
  .form-label {
    @apply block text-sm font-medium text-gray-700 mb-1;
  }
  
  .form-input {
    @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm;
  }
  
  .form-error {
    @apply mt-1 text-sm text-red-600;
  }
  
  /* Optimización para dispositivos móviles */
  @media (max-width: 640px) {
    .form-container {
      width: 98%;
    }
  }
</style>
{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-8 text-left">Editar Paciente</h1>

<div class="form-container">
    <div class="bg-white shadow-md rounded-lg p-6 mb-8">
        <form method="POST" novalidate>
            {% csrf_token %}
            
            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                <!-- Nombre -->
                <div>
                    <label for="{{ form.nombre.id_for_label }}" class="form-label">Nombre</label>
                    {{ form.nombre }}
                    {% if form.nombre.errors %}
                    <p class="form-error">{{ form.nombre.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Apellido -->
                <div>
                    <label for="{{ form.apellido.id_for_label }}" class="form-label">Apellido</label>
                    {{ form.apellido }}
                    {% if form.apellido.errors %}
                    <p class="form-error">{{ form.apellido.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- DNI -->
                <div>
                    <label for="{{ form.dni.id_for_label }}" class="form-label">DNI</label>
                    {{ form.dni }}
                    {% if form.dni.errors %}
                    <p class="form-error">{{ form.dni.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Fecha de Nacimiento -->
                <div>
                    <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label">Fecha de Nacimiento</label>
                    {{ form.fecha_nacimiento }}
                    {% if form.fecha_nacimiento.errors %}
                    <p class="form-error">{{ form.fecha_nacimiento.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Dirección (span completo) -->
                <div class="md:col-span-2">
                    <label for="{{ form.direccion.id_for_label }}" class="form-label">Dirección</label>
                    {{ form.direccion }}
                    {% if form.direccion.errors %}
                    <p class="form-error">{{ form.direccion.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Teléfono -->
                <div>
                    <label for="{{ form.telefono.id_for_label }}" class="form-label">Teléfono</label>
                    {{ form.telefono }}
                    {% if form.telefono.errors %}
                    <p class="form-error">{{ form.telefono.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Email -->
                <div>
                    <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                    {{ form.email }}
                    {% if form.email.errors %}
                    <p class="form-error">{{ form.email.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Botones de acción -->
            <div class="mt-8 flex justify-end space-x-3">
                <a href="{% url 'detalle_paciente' paciente.id %}" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                    Cancelar
                </a>
                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-[#9a4035] hover:bg-[#7a332b] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#9a4035]">
                    Guardar Cambios
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Este script se ejecuta después de que la página carga
    document.addEventListener('DOMContentLoaded', function() {
        // Configurar breadcrumbs para Alpine
        const breadcrumbs = [
            { label: 'Inicio', url: '/' },
            { label: 'Pacientes', url: '/pacientes/' },
            { label: '{{ paciente.nombre }} {{ paciente.apellido }}', url: '{% url "detalle_paciente" paciente.id %}' },
            { label: 'Editar', url: '#' }
        ];
        
        // Si estamos en Alpine, configurar el componente
        if (window.Alpine) {
            Alpine.store('breadcrumbs', breadcrumbs);
            
            // Acceder al componente del header para actualizar sus breadcrumbs
            const header = document.querySelector('[x-data="headerComponent"]');
            if (header && header.__x) {
                header.__x.$data.activeSection = 'pacientes';
                header.__x.$data.breadcrumbs = breadcrumbs;
            }
        }
        
        // Inicializar datepicker para fecha de nacimiento si existe
        if (window.flatpickr) {
            flatpickr("#{{ form.fecha_nacimiento.id_for_label }}", {
                dateFormat: "d/m/Y",
                maxDate: "today",
                locale: "es"
            });
        }
        
        // Validación del DNI
        const dniInput = document.getElementById("{{ form.dni.id_for_label }}");
        if (dniInput) {
            dniInput.addEventListener('blur', function() {
                const dniValue = this.value.trim();
                const dniRegex = /^[0-9]{7,8}$/;
                
                if (!dniRegex.test(dniValue)) {
                    // Mostrar error
                    let errorElement = this.parentNode.querySelector('.form-error');
                    if (!errorElement) {
                        errorElement = document.createElement('p');
                        errorElement.className = 'form-error';
                        this.parentNode.appendChild(errorElement);
                    }
                    errorElement.textContent = 'El DNI debe contener entre 7 y 8 dígitos numéricos';
                } else {
                    // Quitar mensaje de error si existe
                    const errorElement = this.parentNode.querySelector('.form-error');
                    if (errorElement) {
                        errorElement.textContent = '';
                    }
                }
            });
        }
    });
</script>
{% endblock %}